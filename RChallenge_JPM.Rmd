---
title: "The R Challenge"
author: "Paul's Version"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    highlight: tango
    theme: flatly
    toc: yes
    toc_depth: '3'
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: '3'
  pdf_document:
    toc: yes
    toc_depth: '3'
---
#Summary
This is part of an ongoing project increase skills in data analysis, data visualization and R coding for the lab. The data they were using was collected over a number of years using the standard rule-based/information integration RB/IIcategory set. We also collected surveys that ask about participants behavioural habits and we recorded things like the time of year time of day that the experiment was run.

Were going to use this to learn how to unpack a large semi structured Excel spreadsheet and turned it into usable, reproducible data.

##Challenge 1
The first R challenge was just to read in the data, create a a dataframe with *Total* as the DV (this is the total proportion correct) and *Category* (II/RB), *Month* when they were tested and *Time* what time of day they were tested. From this data frame, we should be able to obtain the summary stats broken down by Ind Var, along with data visualization.

##Challenge 2
Include an additional visualization that you did not use before and then do means testing with ANOVA for the Category X Month breakdown and then the Category * Time breakdown.

#Initial steps
##Libraries
The first step to this analysis is to load the necessary libraries. Just uncomment these if they are not already installed.

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
# install.packages('ggplot2')
# install.packages('readxl') #for reading
# install.packages('ez') #for ANOVA
# install.packages('apaTables') #for formatting anova in APA format
# install.packages('RColorBrewer') #for acccesable plots
# install.packages('schoRsch') #for formatting anova in APA format
#install.packages('Rmisc') #quick and easy summarizing
#install.packages('summarytools')

library(ggplot2) 
library(readxl) 
library(ez) 
library(apaTables) 
library(RColorBrewer) 
library(schoRsch)
library(Rmisc)
library(summarytools)
library(knitr)
```

##Data Files
The second step is to load in the data file into a data frame. At the same time, we want to create a data frame with the means, SD, and SE for summarizing things and barplots. I dropped data from the month of may because I know that no one learned the rule described category set. This wasn't made clear in the original instructions for the R challenge so I'm probably the only one who did this

There are number of ways to read in data files. The simplest is to read in a pure text file, my preferred method is to use the 'readxl'  package to import the data file directly from Excel. I then create a subset of the original data without data from the month of May
 
```{r}
ModifiedFullData <- read_excel("ModifiedFullData.xlsx")
#we drop the may data, becasue there are not many people, no one learned the 
#RD set, and it's a different sample, recruited in a different way.
#the full data that will be reported in the paper will not include these data
dm<-subset(ModifiedFullData,Month!="05_May")
```

##Summarize the whole frame
You can use summarytools to generate a quick and nice-looking handout. This is one way to look at all the data at one time. It does not creat an object, though.
One caveat, this won't actually show up in the notebook, so I'm going to keep this commented for now.
```{r}
#view(dfSummary(dm))
#dfSummary(dm)
```


#R Challenge 1 - Summary and Data Viz

The first R  challenge was about reading in the data, visualizing it, and creating a table of means. In this case, were going to be looking at the column of data that corresponds to total performance and averaging across category set.

The first analysis is an examination of total performance by *Month*. The following tables and box plots the mean/median performance on each kind of category set (RD - Rule Described, II - Information Integration). The general trend, clearly evident in the data, is an effect of category set on performance. Participants perform much better on the RD categories relative to the II categories. Also evident in the data, is some variability by month. A visual inspection of the data reveals several outliers, but no clear interaction between category set and month.

##Category Set By Month Table
I create a list of factors that I want to I average across, in this case its a *list* of category and month. I used the *aggregate* function from core R to create a table of means, a table of standard deviations, number of observations, and I calculated the standard error. I glued these together into a overall data frame called means. I can then call the means data frame to see all of the numbers.  I should probably format this better, but for now it gives me everything I need.

###Using Aggregate
This was how I carried it out the first time. I used the core R aggregate function to calculate means, sd, se, etc. Then glued it together in a single frame. Not very elegant but it works
```{r}
f<-list(dm$Cat,dm$Month)
means<-aggregate(dm$Total, f, FUN="mean")
sd<-aggregate(dm$Total, f, FUN="sd")
n<-aggregate(dm$Total, f, FUN="length")
SE<-sd$x/sqrt(n$x)
colnames(means)<-c("Cat", "Month", "Mean")
means$sd<-sd$x
means$n<-n$x
means$SE<-SE
means
```

###Using Summary SE
Probably easier to use the summarySE function. This function is part of the Rmisc library and is well suited for generating quick tables when the data are properly structured in long format.

First a table that just calculates the means for each category set.

```{r}
dt<-summarySE(data = dm, measurevar="Total", groupvars = c("Cat"),
    na.rm = FALSE, conf.interval = 0.95, .drop = TRUE)
kable(dt, digits=3)#simple way to round
```

This table breaks the data into **category** and **month**
```{r}
dtM<-summarySE(data = dm, measurevar="Total", groupvars = c("Cat","Month"),
    na.rm = FALSE, conf.interval = 0.95, .drop = TRUE)
kable(dtM, digits=3)

```


##Category Set By Month BoxPlot
The box part is pretty straightforward, I use the data frame that I created with the subset, and part performance by month. I prefer to use Colour Brewer to create interesting pallets. This one is called paired, and the more observations you have the more shades of blue it gives you. I also like the classic theme

```{r}
ggplot(dm,aes(x=Month, y=Total, fill=Cat))+
  geom_boxplot() +
  ggtitle("Performance by Month") +
  scale_fill_discrete(name = "Category")+
  scale_fill_brewer(palette="Paired")+
  theme_classic()
```

##Category Set By Month Bar Plot

The box plot above is a very good visualization of the overall data, but doesn't always work if you want to do means testing with t-tests or ANOVAs later. So I'm going to create a bar plot. This is where the aggregate data frame that I created above comes in handy. It's much easier to do the bar plod on a table it means.

In particular, this makes it really easy to create the error bars.

The first plot was created with my old-fashion' way of calculating the table of means. The second uses the "summarSE" function. They are the same, so we'll just use this from now on. 

```{r}
ggplot(means,aes(x=Month, y=Mean, fill=Cat))+
  geom_bar(position = "dodge",color="black", stat="identity")+
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width = 0.2,
                position =position_dodge(.9))+
  ggtitle("Performance by Month") +
  scale_fill_discrete(name = "Category")+
  scale_fill_brewer(palette="Paired")+
  theme_classic()

ggplot(dtM,aes(x=Month, y=Total, fill=Cat))+
  geom_bar(position = "dodge",color="black", stat="identity")+
  geom_errorbar(aes(ymin = Total-se, ymax = Total+se), width = 0.2,
                position =position_dodge(.9))+
  ggtitle("Performance by Month") +
  scale_fill_discrete(name = "Category")+
  scale_fill_brewer(palette="Paired")+
  theme_classic()


```


##Analysis By Time

The second set of analysis we want to do is to look at total performance on the two category sets by time of day. The datafile already groups them into Morning, Early Afternoon and Late Afternoon, so we just need to use that column to create the data frame. *Old way* Again using the subset without data from the month of May, I created a factor list this time using category (Cat) and time (Time2). Time2  Was used in this case because it bins the actual time into the three larger time frames. This was done by the original program. Once I have the factor list, I can then aggregate to create a data frame called meansT (for time).  I also aggregate to find the standard deviation, the number of observations and I calculate the standard error. I then glue them together into one data frame that I can plot and analyse.*new way* use the summarySE to generate the same data frame


```{r}
dtT<-summarySE(data = dm, measurevar="Total", groupvars = c("Cat","Time2"),
    na.rm = FALSE, conf.interval = 0.95, .drop = TRUE)
kable(dt, digits=3)
```

##Category Set By Time BoxPlot
 The box plot shows the median and the range for performance at each of the three time points divided by category set. Not surprisingly, performance is always better on the rule described category sets. And because were looking at the same data just grouped by time instead of my month, there are outliers in this data as well.

```{r}
ggplot(dm,aes(x=Time2, y=Total, fill=Cat))+
  geom_boxplot() +
  ggtitle("Performance by Time of Day") +
  scale_fill_discrete(name = "Category")+
  scale_fill_brewer(palette="Paired")+
  theme_classic()
```

##Category Set By Month Bar Plot
 the bar plot visualizes the data by means and standard error, rather than by median and quartile. Performance is always higher on the rule described category sets, and it doesn't seem to be much variation with time.

```{r}
ggplot(dtT,aes(x=Time2, y=Total, fill=Cat))+
  geom_bar(position = "dodge", color="black", stat="identity")+
  geom_errorbar(aes(ymin = Total-se, ymax = Total+se), width = 0.2,
                position =position_dodge(.9))+
  ggtitle("Performance by Time") +
  scale_fill_discrete(name = "Category")+
  scale_fill_brewer(palette="Paired")+
  theme_classic()
```

#R Challenge 2 - ANOVAs
The main part of the second challenge was to do some means testings. Let's test the means for Total as DV with *Category* and *Month* as the IVs. 

Just use the EZ package for now, though aov is OK here too (We'll find out)

##ANOVA on Total with Cat and Month

```{r message=FALSE, warning=FALSE}
a<-ezANOVA(dm, #the data file
       dv=.(Total), #DV
       wid=.(UniqueSubjNum), #subject as within ID means subject is the error term 
       between=.(Cat,Month), #Cat and Month as IVs
       detailed=TRUE,
       return_aov = FALSE,
       type=3)

#here's one was to get the full table in apa style.
#this makes an object, I think...the other is primarily printing 
#to the console
apa.ezANOVA.table(a) 


#here's another way, a bit more information in the second one
# I will be using this format from here on in
anova_out(a, print = TRUE, sph.cor = "no", mau.p = 0.05,
          etasq = "partial", dfsep = ", ")

```

##ANOVA on Total RD (only) with Month
Create a subset and do the one way ANOVA. Not needed, BTW since there is no interaction term. We're just looking at how to do the ANOVA...
```{r message=FALSE, warning=FALSE}
dmRD<-subset(dm,dm$Cat=="RD")
a<-ezANOVA(dmRD, 
       dv=.(Total), 
       wid=.(UniqueSubjNum), 
       between=.(Month), 
       detailed=TRUE,
       return_aov = FALSE,
       type=3)

anova_out(a, print = TRUE, sph.cor = "no", mau.p = 0.05,
          etasq = "partial", dfsep = ", ")
```
##ANOVA on Total II (only) with Month
Same as above, but on Month

```{r message=FALSE, warning=FALSE}
dmII<-subset(dm,dm$Cat=="II")
a<-ezANOVA(dmII, 
       dv=.(Total), 
       wid=.(UniqueSubjNum), 
       between=.(Month), 
       detailed=TRUE,
       return_aov = FALSE,
       type=3)

#apa.ezANOVA.table(a)
anova_out(a, print = TRUE, sph.cor = "no", mau.p = 0.05,
          etasq = "partial", dfsep = ", ")
```

##ANOVA on Total with Cat and Time
This is an ANOVA on total with Cat and Time 2 as the factores. This goes along with the bar plot above. 
```{r message=FALSE, warning=FALSE}
a<-ezANOVA(dm, 
       dv=.(Total), 
       wid=.(UniqueSubjNum), 
       between=.(Cat,Time2), 
       detailed=TRUE,
       return_aov = FALSE,
       type=3)

#apa.ezANOVA.table(a)
anova_out(a, print = TRUE, sph.cor = "no", mau.p = 0.05,
          etasq = "partial", dfsep = ", ")

```
##ANOVA on Total RD (Only) with Time


```{r message=FALSE, warning=FALSE}
a<-ezANOVA(dmRD, 
       dv=.(Total), 
       wid=.(UniqueSubjNum), 
       between=.(Time2), 
       detailed=TRUE,
       return_aov = FALSE,
       type=3)

#apa.ezANOVA.table(a)
anova_out(a, print = TRUE, sph.cor = "no", mau.p = 0.05,
          etasq = "partial", dfsep = ", ")

```

##ANOVA on Total II (Only) with Time


```{r message=FALSE, warning=FALSE}
a<-ezANOVA(dmII, 
       dv=.(Total), 
       wid=.(UniqueSubjNum), 
       between=.(Time2), 
       detailed=TRUE,
       return_aov = FALSE,
       type=3)

#apa.ezANOVA.table(a)
anova_out(a, print = TRUE, sph.cor = "no", mau.p = 0.05,
          etasq = "partial", dfsep = ", ")

```
